<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Panel</title>
<link rel="stylesheet" href="style.css"/>
<script src="config.js"></script>
<script src="app.js"></script>
<script src="./common.js"></script>
<script>
  requireRole(['admin','owner']); // allow owner to view admin panel
  renderNav('topNav');
</script>
</head><body>
  <div id="topNav"></div>
<div class="container">
  <div class="topbar">
    <a href="owner.html">Go to Owner (test)</a>
    <div><button class="btn-outline" onclick="logout()">Logout</button></div>
  </div>

  <div class="card">
    <h1>Admin â€¢ Available Stocks</h1>
    <div class="row">
      <select id="durationSelect"></select>
    </div>
    <table>
      <thead>
        <tr><th>Product</th><th>Type</th><th>Qty</th><th style="text-align:right">Action</th></tr>
      </thead>
      <tbody id="adminStockTbody"></tbody>
    </table>
  </div>

  <div class="card" id="lastBox" style="display:none">
    <h1>Last Provided Credentials</h1>
    <div id="creds"></div>
    <div style="margin-top:10px"><button class="btn-outline" onclick="copyCreds()">Copy creds</button></div>
  </div>
</div>

<script>
  const u = requireRole(['admin']);
  fillDuration(document.getElementById('durationSelect'));

  function renderAdminTable(rows){
    const tb = document.getElementById('adminStockTbody');
    tb.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.product_label||r.product_key}</td>
        <td>${r.account_type}</td>
        <td style="text-align:right">${r.total_qty}</td>
        <td style="text-align:right">
          <button class="btn-xs" data-product="${r.product_key}" data-type="${r.account_type}">Get Account</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  document.getElementById('adminStockTbody').addEventListener('click', async (e)=>{
    if(e.target.tagName === 'BUTTON'){
      const product_key = e.target.dataset.product;
      const account_type = e.target.dataset.type;
      const duration_days = parseInt(document.getElementById('durationSelect').value,10);
      const res = await adminGetAccount({product_key, account_type, duration_days});
      if(!res) return;
      document.getElementById('lastBox').style.display = 'block';
      document.getElementById('creds').innerText =
        `Email: ${res.email||''}\nPassword: ${res.password||''}\nProfile: ${res.profile_name||''}\nPIN: ${res.pin||''}\nExpires: ${new Date(res.expires_at).toLocaleString()}\nSale ID: ${res.sale_id}`;
      await loadStockSummary(document.getElementById('adminStockTbody')).then(renderAdminTable);
    }
  });

  function copyCreds(){
    const t = document.getElementById('creds').innerText;
    navigator.clipboard.writeText(t);
    alert('Copied.');
  }

  (async ()=>{
    const rows = await loadStockSummary(document.getElementById('adminStockTbody'));
    renderAdminTable(rows);
  })();
</script>
</body></html>