<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin • AiaxStock</title>
  <link rel="stylesheet" href="./style.css"/>
  <script type="module">
    import { getRole, getUID, logout, fetchAvailableSummary, rpcGetAccount, listMySales, fmt, toast } from "./app.js";
    import { DURATION_MAP } from "./config.js";

    if(getRole()!=="admin"){ location.href="./index.html"; }

    async function refreshAvailable(){
      const rows = await fetchAvailableSummary();
      avail.innerHTML = rows.map(r=>`<div class="badge">${r.product_key} • ${r.account_type} • ${r.qty}</div>`).join(" ");
      prod.innerHTML = rows.map(r=>`<option value="${r.product_key}|${r.account_type}">${r.product_key} — ${r.account_type} (${r.qty})</option>`).join("");
    }

    async function refreshMySales(){
      const rows = await listMySales(getUID());
      myBody.innerHTML = rows.map(r=>`
        <tr><td>${r.id}</td><td>${r.product_key}</td><td>${r.account_type}</td>
            <td>${fmt(r.created_at)}</td><td>${fmt(r.expires_at)}</td>
            <td>${r.buyer_link||""}</td><td>${r.price||""}</td></tr>`).join("");
    }

    async function doGetAccount(){
      if(!prod.value) return alert("Pick a product");
      const [product_key, account_type] = prod.value.split("|");
      const duration_days = Number(DURATION_MAP[duration.value]||0);
      const payload = {
        p_admin: getUID(),
        p_product_key: product_key,
        p_account_type: account_type,
        p_duration_days: duration_days,
        p_price: Number(price.value||0),
        p_buyer_link: buyer.value||null
      };
      const row = await rpcGetAccount(payload);
      if(!row){ toast("No stock available"); return; }
      creds.value = `Email: ${row.email||""}\nPass: ${row.password||""}\nProfile: ${row.profile_name||""}\nPIN: ${row.pin||""}\nExpires: ${fmt(row.expires_at)}`;
      await refreshMySales();
      await refreshAvailable();
    }

    window.refreshAvailable = refreshAvailable;
    window.refreshMySales = refreshMySales;
    window.doGetAccount = doGetAccount;
    window.logout = logout;

    window.onload = async ()=>{ await refreshAvailable(); await refreshMySales(); };
  </script>
</head>
<body>
  <div class="nav"><div class="nav-inner container">
    <div class="brand">AiaxStock — Admin</div>
    <div class="toolbar">
      <!-- Admin deliberately cannot jump to Owner -->
      <button class="btn secondary" onclick="logout()">Logout</button>
    </div>
  </div></div>

  <div class="container">
    <section class="card">
      <div class="toolbar"><h2>Available Stocks</h2><button class="btn small" onclick="refreshAvailable()">Refresh</button></div>
      <div id="avail" class="grid"></div>
    </section>

    <section class="card">
      <h2>Get Account</h2>
      <div class="grid two">
        <div>
          <label>Product (only those with stock)</label>
          <select id="prod"></select>
        </div>
        <div>
          <label>Duration</label>
          <select id="duration">
            <option value="7d">7 days</option><option value="14d">14 days</option>
            <option value="1m">1 month</option><option value="2m">2 months</option>
            <option value="3m">3 months</option><option value="6m">6 months</option>
            <option value="12m">12 months</option>
          </select>
        </div>
        <div><label>Buyer social link</label><input id="buyer" placeholder="@username or link"/></div>
        <div><label>Price</label><input id="price" type="number" placeholder="e.g. 149.00"/></div>
      </div>
      <div class="toolbar"><button class="btn" onclick="doGetAccount()">Get Account</button></div>
      <textarea id="creds" rows="4" style="width:100%" placeholder="Credentials will appear here..." readonly></textarea>
    </section>

    <section class="card">
      <div class="toolbar"><h2>My Buyers Record</h2><button class="btn small" onclick="refreshMySales()">Refresh</button></div>
      <table class="table">
        <thead><tr><th>ID</th><th>Product</th><th>Type</th><th>Created</th><th>Expires</th><th>Buyer link</th><th>Price</th></tr></thead>
        <tbody id="myBody"></tbody>
      </table>
    </section>
  </div>

  <div id="toast" class="toast"></div>
</body>
</html>