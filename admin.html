<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AiaxStock • Admin</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
</head>
<body class="pink-bg">
  <header class="topbar">
    <div class="brand">AiaxStock Management — <b>Admin</b></div>
    <nav>
      <!-- Owner link hidden for admins -->
      <button class="btn small" onclick="logout()">Logout</button>
    </nav>
  </header>

  <main class="container">
    <!-- Stock summary (no secrets) -->
    <section class="panel">
      <h2>Available Stocks</h2>
      <div id="stock-summary"></div>
    </section>

    <!-- Get Account -->
    <section class="panel">
      <h2>Get Account</h2>

      <label>Product</label>
      <select id="product"></select>

      <div class="grid2">
        <div>
          <label>Account type</label>
          <select id="acct"></select>
        </div>
        <div>
          <label>Duration</label>
          <select id="dur"></select>
        </div>
      </div>

      <button class="btn pink" onclick="getAccount()">Get Account</button>

      <div id="creds" class="mt"></div>
    </section>

    <!-- My Buyers Record -->
    <section class="panel">
      <h2>My Buyers Record</h2>
      <div id="my-sales"></div>
    </section>
  </main>

  <script>
    const s = requireRole(['admin','owner']); if (!s) return;  // Owner can see Admin page
    const db = supabase.createClient(APP.url, APP.key);

    // Durations fixed list
    const DURS = [7,14,30,60,90,120,150,180,210,240,270,300,330,365];

    // 1) STOCK SUMMARY + feed selects with only "in stock"
    async function loadStockSummary() {
      const { data, error } = await db.rpc('list_products_in_stock', { p_owner: APP.ownerId });
      if (error) { alert(error.message); return; }

      // render table
      const el = document.getElementById('stock-summary');
      el.innerHTML = `
        <table class="tbl">
          <thead><tr><th>Product</th><th>Type</th><th>Duration</th><th>Qty</th></tr></thead>
          <tbody>
            ${(data||[]).map(r=>`
              <tr>
                <td>${r.product_key}</td>
                <td>${r.account_type}</td>
                <td>${r.duration_days}d</td>
                <td>${r.qty}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;

      // feed the selects
      const prodSel = document.getElementById('product');
      const acctSel = document.getElementById('acct');
      const durSel  = document.getElementById('dur');

      // unique products first
      const prods = [...new Set((data||[]).map(r => r.product_key))];
      prodSel.innerHTML = prods.map(k => `<option value="${k}">${k}</option>`).join('');

      // when product changes, refresh type/duration choices limited by stock
      function refreshTypeDur() {
        const p = prodSel.value;
        const rows = (data||[]).filter(r => r.product_key === p);
        const types = [...new Set(rows.map(r=>r.account_type))];
        acctSel.innerHTML = types.map(t=>`<option value="${t}">${t}</option>`).join('');

        const durs = [...new Set(rows.map(r=>r.duration_days))].sort((a,b)=>a-b);
        durSel.innerHTML = durs.map(d=>`<option value="${d}">${d} days</option>`).join('');
      }
      prodSel.onchange = refreshTypeDur;
      refreshTypeDur();
    }

    // 2) GET ACCOUNT (calls your existing RPC that decrements stock + records sale)
    async function getAccount() {
      const product_key  = document.getElementById('product').value;
      const account_type = document.getElementById('acct').value;
      const duration     = parseInt(document.getElementById('dur').value,10);

      const { data, error } = await db.rpc('get_account', {
        p_owner_id: APP.ownerId,
        p_admin_id: s.uid,
        p_product_key: product_key,
        p_account_type: account_type,
        p_duration_days: duration
      });

      if (error) { alert(error.message); return; }
      const c = data; // credentials row returned by RPC

      document.getElementById('creds').innerHTML = `
        <div class="creds">
          <div><b>Email</b> ${c.email ?? ''}</div>
          <div><b>Password</b> ${c.password ?? ''}</div>
          <div><b>Profile</b> ${c.profile_name ?? ''}</div>
          <div><b>PIN</b> ${c.pin ?? ''}</div>
          <div><b>Expires</b> ${new Date(c.expires_at).toLocaleString()}</div>
        </div>`;
      await loadMySales(); // refresh my record
      await loadStockSummary(); // qty goes down
    }

    // 3) MY BUYERS RECORD
    async function loadMySales() {
      const { data, error } = await db.rpc('list_my_sales', { p_admin: s.uid });
      if (error) return;
      const el = document.getElementById('my-sales');
      el.innerHTML = `
        <table class="tbl">
          <thead><tr>
            <th>ID</th><th>Product</th><th>Type</th>
            <th>Created</th><th>Expires</th><th>Buyer link</th><th>Price</th>
          </tr></thead>
          <tbody>
            ${(data||[]).map(r=>`
            <tr>
              <td>${r.id}</td>
              <td>${r.product_key}</td>
              <td>${r.account_type}</td>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td>${new Date(r.expires_at).toLocaleString()}</td>
              <td>${r.buyer_link ?? ''}</td>
              <td>${r.price ?? ''}</td>
            </tr>`).join('')}
          </tbody>
        </table>`;
    }

    // INIT
    (async () => {
      await loadStockSummary();
      await loadMySales();
    })();
  </script>
</body>
</html>