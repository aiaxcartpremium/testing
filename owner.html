<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Owner • AiaxStock</title>
<link rel="preconnect" href="https://esm.sh">
<style>
  :root{ --pink1:#FFE5EC; --pink2:#FFB3C6; --pink3:#FF8FAB; --pink4:#FFC2D1; }
  body{margin:0;font-family:system-ui,Inter,Arial;background:linear-gradient(#ffe9f1,#ffdbe6,#ffe9f1);}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
  .brand{font-weight:900;font-size:20px;color:#7a0033}
  nav a{margin-right:16px;text-decoration:none;font-weight:700;color:#0066dd}
  .btn{background:linear-gradient(180deg,var(--pink2),var(--pink3));border:none;color:#fff;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .card{background:#fff;border-radius:18px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:18px;margin:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  label{font-weight:700;margin-top:8px;display:block}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e9d1da;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #eee; font-size:14px}
  .tabs{display:flex;gap:8px;margin:0 16px}
  .tab{padding:10px 12px;border-radius:10px;background:#fff;border:1px solid #ffd1df;cursor:pointer;font-weight:700}
  .tab.active{background:linear-gradient(180deg,var(--pink2),var(--pink3));color:#fff;border:none}
  .muted{color:#777;font-size:13px}
</style>
</head>
<body>
<header>
  <div class="brand">AiaxStock Management — <b>Owner</b></div>
  <nav>
    <a href="admin.html">Go to Admin</a>
    <button class="btn" onclick="__APP__.logout()">Logout</button>
  </nav>
</header>

<div class="tabs">
  <button class="tab active" data-tab="add">Add stock</button>
  <button class="tab" data-tab="stocks">Stocks</button>
  <button class="tab" data-tab="records">Records</button>
</div>

<section id="tab-add" class="card">
  <h2>Add Stock</h2>
  <div class="row3">
    <div>
      <label>Product</label>
      <select id="p_product"></select>
    </div>
    <div>
      <label>Account type</label>
      <select id="p_type">
        <option>shared profile</option>
        <option>solo profile</option>
        <option>shared account</option>
        <option>solo account</option>
        <option>invitation</option>
        <option>head</option>
        <option>edu</option>
      </select>
    </div>
    <div>
      <label>Duration</label>
      <select id="p_duration">
        <option value="7days">7 days</option>
        <option value="14days">14 days</option>
        <option value="1m">1 month</option>
        <option value="2m">2 months</option>
        <option value="3m">3 months</option>
        <option value="4m">4 months</option>
        <option value="5m">5 months</option>
        <option value="6m">6 months</option>
        <option value="7m">7 months</option>
        <option value="8m">8 months</option>
        <option value="9m">9 months</option>
        <option value="10m">10 months</option>
        <option value="11m">11 months</option>
        <option value="12m">12 months</option>
        <option value="auto-renew">auto-renew</option>
      </select>
      <div class="muted" id="expiryHint"></div>
    </div>
  </div>

  <div class="row3" style="margin-top:8px">
    <div><label>Quantity</label><input id="p_qty" type="number" min="1" value="1"/></div>
    <div><label>Email (optional)</label><input id="p_email" placeholder="login email"/></div>
    <div><label>Password (optional)</label><input id="p_password" placeholder="login password"/></div>
    <div><label>Profile (optional)</label><input id="p_profile" placeholder="profile name"/></div>
    <div><label>PIN (optional)</label><input id="p_pin" placeholder="profile pin"/></div>
    <div><label>Notes</label><input id="p_notes" placeholder="any notes"/></div>
  </div>

  <div style="margin-top:12px">
    <button class="btn" id="btnAdd">Add stock</button>
  </div>
</section>

<section id="tab-stocks" class="card" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Current Stocks</h2>
    <button class="btn" id="btnRefreshStocks">Refresh</button>
  </div>
  <table id="tblStocks"><thead>
    <tr><th>ID</th><th>Product</th><th>Type</th><th>Expires</th><th></th></tr>
  </thead><tbody></tbody></table>
  <div class="muted">Tap “Remove” if you encoded a wrong row.</div>
</section>

<section id="tab-records" class="card" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>All Sales (by any Admin)</h2>
    <button class="btn" id="btnExport">Export CSV</button>
  </div>
  <table id="tblSales"><thead>
    <tr><th>ID</th><th>Product</th><th>Type</th><th>Created</th><th>Expires</th><th>Buyer</th><th>Price</th><th>Admin</th></tr>
  </thead><tbody></tbody></table>
</section>

<script src="config.js"></script>
<script type="module" src="app.js"></script>
<script>
const A = window.__APP__;
const ctx = A.assertRole(['owner']); if(!ctx) throw 0;
const uid = ctx.uid;

const el = s=>document.querySelector(s);
const expiryHint = el('#expiryHint');

function previewExpiry(){
  const map = {
    '7days':7,'14days':14,
    '1m':'1 month','2m':'2 months','3m':'3 months','4m':'4 months','5m':'5 months',
    '6m':'6 months','7m':'7 months','8m':'8 months','9m':'9 months','10m':'10 months',
    '11m':'11 months','12m':'12 months','auto-renew':'auto'
  };
  const v = el('#p_duration').value;
  if(v==='auto-renew'){ expiryHint.textContent = 'Expiry: Auto-renew'; return; }
  let d = new Date();
  if(v.endsWith('days')) d.setDate(d.getDate()+parseInt(v));
  else if(v.endsWith('m')) d.setMonth(d.getMonth()+parseInt(v));
  expiryHint.textContent = 'Expiry: ' + d.toLocaleString();
}
el('#p_duration').addEventListener('change', previewExpiry);
previewExpiry();

// tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name = t.dataset.tab;
    ['add','stocks','records'].forEach(n=>{
      el('#tab-'+n).style.display = (n===name)?'block':'none';
    });
  };
});

// load products into select
(async ()=>{
  const list = await A.fetchProducts();
  const sel = el('#p_product');
  sel.innerHTML = list.map(x=>`<option value="${x.key}">${x.label}</option>`).join('');
})();

// add stock handler
el('#btnAdd').onclick = async()=>{
  try{
    const payload = {
      owner: uid,
      product: el('#p_product').value,
      type: el('#p_type').value,
      qty: parseInt(el('#p_qty').value||'1'),
      email: el('#p_email').value,
      password: el('#p_password').value,
      profile: el('#p_profile').value,
      pin: el('#p_pin').value,
      duration: el('#p_duration').value
    };
    const inserted = await A.addStockBulk(payload);
    alert(`Added ${inserted||payload.qty} stock(s).`);
    await refreshStocks();
  }catch(err){ console.error(err); alert('Add failed: '+err.message); }
};

// owner stocks table (light listing)
async function refreshStocks(){
  // show only this owner’s stocks (no secrets in table)
  const { data, error } = await sb.from('stocks')
     .select('id,product_key,account_type,expires_at')
     .eq('owner_id', uid)
     .order('created_at',{ascending:false}).limit(200);
  if(error){ console.error(error); return; }
  const tb = el('#tblStocks tbody');
  tb.innerHTML = (data||[]).map(r=>`
    <tr>
      <td>${r.id.slice(0,8)}…</td>
      <td>${r.product_key}</td>
      <td>${r.account_type}</td>
      <td>${r.expires_at?new Date(r.expires_at).toLocaleString():'—'}</td>
      <td><button class="btn" data-id="${r.id}" data-act="del">Remove</button></td>
    </tr>`).join('');
}
el('#btnRefreshStocks').onclick = refreshStocks;
el('#tblStocks').onclick = async(e)=>{
  const btn = e.target.closest('button[data-act="del"]');
  if(!btn) return;
  if(!confirm('Remove this stock row?')) return;
  try{ await A.deleteStock(uid, btn.dataset.id); await refreshStocks(); }
  catch(err){ alert('Delete failed: '+err.message); }
};

// owner sales
async function refreshSales(){
  const rows = await A.listOwnerSales(uid);
  const tb = el('#tblSales tbody');
  tb.innerHTML = rows.map(r=>`
   <tr>
     <td>${r.id}</td>
     <td>${r.product_key}</td>
     <td>${r.account_type}</td>
     <td>${new Date(r.created_at).toLocaleString()}</td>
     <td>${r.expires_at?new Date(r.expires_at).toLocaleString():'—'}</td>
     <td>${r.buyer_link||''}</td>
     <td>${r.price??''}</td>
     <td>${(r.admin_id||'').slice(0,8)}</td>
   </tr>`).join('');
}

// export CSV
el('#btnExport').onclick = async()=>{
  const rows = await A.listOwnerSales(uid);
  const header = ['id','product_key','account_type','created_at','expires_at','buyer_link','price','admin_id'];
  const csv = [header.join(',')].concat(
    rows.map(r=>[r.id,r.product_key,r.account_type,r.created_at,r.expires_at,r.buyer_link||'',r.price||'',r.admin_id||''].join(','))
  ).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'owner-sales.csv'; a.click();
};

refreshStocks(); refreshSales();
</script>
</body></html>