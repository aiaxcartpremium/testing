<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AiaxStock • Owner</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
</head>
<body class="pink-bg">
  <header class="topbar">
    <div class="brand">AiaxStock Management — <b>Owner</b></div>
    <nav>
      <a class="link" href="admin.html">Go to Admin</a>
      <button class="btn small" onclick="logout()">Logout</button>
    </nav>
  </header>

  <main class="container">
    <section class="panel">
      <h2>Add Stock</h2>

      <label>Product</label>
      <select id="product"></select>

      <label>Account type</label>
      <select id="acct">
        <option value="shared profile">shared profile</option>
        <option value="solo profile">solo profile</option>
        <option value="shared account">shared account</option>
        <option value="solo account">solo account</option>
      </select>

      <label>Duration</label>
      <select id="dur"></select>

      <label>Quantity</label>
      <input id="qty" type="number" min="1" value="1"/>

      <label>Email (optional)</label>
      <input id="email" placeholder="login email"/>

      <label>Password (optional)</label>
      <input id="pass" placeholder="login password"/>

      <label>Profile (optional)</label>
      <input id="profile" placeholder="profile name"/>

      <label>PIN (optional)</label>
      <input id="pin" placeholder="profile pin"/>

      <label>Notes</label>
      <input id="notes" placeholder="any notes"/>

      <button class="btn pink" onclick="addStock()">Add stock</button>
    </section>

    <section class="panel">
      <h2>Admin Sales (all)</h2>
      <div id="owner-sales"></div>
    </section>
  </main>

  <script>
    const s = requireRole(['owner']); if (!s) return;
    const db = supabase.createClient(APP.url, APP.key);

    const DURS = [
      7,14,30,60,90,120,150,180,210,240,270,300,330,365
    ];
    function fillDurations() {
      const sel = document.getElementById('dur');
      sel.innerHTML = DURS.map(d=>`<option value="${d}">${d} days</option>`).join('');
    }

    async function loadProducts() {
      const { data, error } = await db.from('products')
        .select('key,label,category').order('category, label');
      const sel = document.getElementById('product');
      if (error) { alert(error.message); return; }
      sel.innerHTML = data.map(p => `<option value="${p.key}">${p.label} • ${p.category}</option>`).join('');
    }

    async function addStock() {
      const body = {
        owner_id: s.uid,
        product_key: document.getElementById('product').value,
        account_type: document.getElementById('acct').value,
        duration_days: parseInt(document.getElementById('dur').value,10),
        quantity: parseInt(document.getElementById('qty').value,10),
        email: document.getElementById('email').value || null,
        password: document.getElementById('pass').value || null,
        profile_name: document.getElementById('profile').value || null,
        pin: document.getElementById('pin').value || null,
        notes: document.getElementById('notes').value || null
      };
      const { error } = await db.from('stocks').insert(body);
      if (error) return alert(error.message);
      alert('Stock added!');
    }

    // (optional) Owner view of all admin sales
    async function loadOwnerSales() {
      const { data, error } = await db.from('sales')
        .select('id,product_key,account_type,admin_id,created_at,expires_at,price,buyer_link')
        .order('id', { ascending:false })
        .limit(50);
      if (error) return;
      const el = document.getElementById('owner-sales');
      el.innerHTML = `
        <table class="tbl">
          <thead><tr>
            <th>ID</th><th>Product</th><th>Type</th><th>Admin</th>
            <th>Created</th><th>Expires</th><th>Price</th><th>Buyer</th>
          </tr></thead>
          <tbody>
            ${(data||[]).map(r=>`
              <tr>
                <td>${r.id}</td><td>${r.product_key}</td><td>${r.account_type}</td><td>${r.admin_id}</td>
                <td>${new Date(r.created_at).toLocaleString()}</td>
                <td>${new Date(r.expires_at).toLocaleString()}</td>
                <td>${r.price ?? ''}</td><td>${r.buyer_link ?? ''}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }

    fillDurations();
    loadProducts();
    // loadOwnerSales(); // keep if you want an owner-wide sales table
  </script>
</body>
</html>